<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ°ì˜ˆìŠ¬ì´ë„¤ ì¹´í˜</title>
  <style>
    :root{
      --bg1:#fff0f6; --bg2:#ffe6f0; --card:#ffffffcc; --line:#ffd1e3;
      --ink:#3b2a33; --muted:#7a5b69; --pink:#ff5fa2; --pink2:#ff86ba;
      --choco:#5a3340; --shadow:0 18px 40px rgba(255,95,162,.15); --shadow2:0 10px 24px rgba(90,51,64,.08);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg2),var(--bg1));
      color:var(--ink);
      min-height:100vh;
    }
    .wrap{max-width:960px;margin:0 auto;padding:26px 16px 60px}
    .hero{
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:18px;
      box-shadow:var(--shadow);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:52px;height:52px;border-radius:18px;
      background:linear-gradient(135deg,var(--pink),#ffb0d1);
      display:grid;place-items:center;color:#fff;font-size:24px;
      box-shadow:0 12px 22px rgba(255,95,162,.22);
      flex:0 0 auto;
    }
    h1{margin:0;font-size:20px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.5}
    .badge{
      display:inline-flex;align-items:center;gap:8px;margin-top:10px;
      padding:8px 12px;border-radius:999px;background:#fff;border:1px solid var(--line);
      box-shadow:var(--shadow2);font-size:12px;color:var(--choco)
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--pink);box-shadow:0 0 0 5px rgba(255,95,162,.15)}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:16px;
      box-shadow:var(--shadow2);
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px;font-size:15px;color:var(--choco);display:flex;gap:8px;align-items:center}
    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--choco)}
    input,textarea{
      width:100%;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#fff7fb);
      outline:none;
      font-size:14px;
      color:var(--ink);
    }
    input:focus,textarea:focus{border-color:var(--pink2);box-shadow:0 0 0 4px rgba(255,134,186,.18)}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:0;border-radius:16px;padding:12px 14px;cursor:pointer;
      font-weight:800;letter-spacing:-.2px;display:inline-flex;gap:8px;align-items:center;
      transition:transform .06s ease,opacity .1s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--pink),var(--pink2));color:#fff;box-shadow:0 14px 26px rgba(255,95,162,.22)}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--choco)}
    .btn.danger{background:linear-gradient(135deg,#6b2d3d,#a04a64);color:#fff;box-shadow:0 14px 26px rgba(90,51,64,.18)}
    .mini{margin:8px 0 0;color:var(--muted);font-size:12px;line-height:1.5}

    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .search{flex:1 1 240px;max-width:460px;position:relative}
    .search input{padding-left:38px}
    .search:before{content:"ğŸ”";position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
    .pill{padding:8px 12px;border-radius:999px;border:1px dashed #ffb0d1;background:#fff;color:var(--muted);font-size:12px;white-space:nowrap}
    .posts{display:grid;gap:12px}
    .post{
      background:#fff;border:1px solid var(--line);border-radius:var(--r);
      padding:14px;box-shadow:var(--shadow2);
    }
    .post h3{margin:0;font-size:16px;color:var(--choco);display:flex;gap:8px;align-items:center}
    .lock{font-size:14px}
    .post p{margin:10px 0 0;line-height:1.65;white-space:pre-wrap;color:#5a3a48}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .meta .left{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tag{padding:6px 10px;border-radius:999px;background:#fff0f7;border:1px solid var(--line);color:#8a4a60}
    .actions{display:flex;gap:8px;align-items:center}
    .tiny{
      border:1px solid var(--line);background:#fff;color:var(--choco);
      padding:8px 10px;border-radius:14px;cursor:pointer;font-weight:800;
    }
    .tiny.danger{background:#fff0f0;border-color:#ffc1c7;color:#8a2f3f}
    .empty{padding:18px;border-radius:var(--r);border:1px dashed #ffb0d1;background:rgba(255,255,255,.8);color:var(--muted);text-align:center}
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(255,255,255,.92);border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;box-shadow:var(--shadow);
      display:none;z-index:50;font-size:13px;color:var(--choco)
    }
    .checkRow{display:flex;gap:10px;align-items:center;margin-top:10px}
    .checkRow input{width:auto}
    .editBox{margin-top:10px;display:grid;gap:8px}
    .editBox input,.editBox textarea{background:#fff}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand">
        <div class="logo">ğŸ°</div>
        <div>
          <h1>Pink Cake Cafe Board</h1>
          <p class="sub">ë¹„ë°€ê¸€ + ì‘ì„±ìë§Œ ìˆ˜ì •/ì‚­ì œ + ì‹¤ì‹œê°„ ë°˜ì˜</p>
          <div class="badge"><span class="dot"></span><span id="status">ë¡œê·¸ì¸ ì—°ê²° ì¤‘â€¦</span></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ§ ê¸€ ì˜¬ë¦¬ê¸°</h2>

        <label for="nickname">ë‹‰ë„¤ì„</label>
        <input id="nickname" placeholder="ì˜ˆ: sara" maxlength="20" />

        <label for="title">ì œëª©</label>
        <input id="title" placeholder="ì˜ˆ: ë”¸ê¸° ìƒí¬ë¦¼ í›„ê¸°" maxlength="60" />

        <label for="content">ë‚´ìš©</label>
        <textarea id="content" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì¼€ì´í¬ê°€ ì •ë§ ë¶€ë“œëŸ¬ì› ì–´ìš”â€¦"></textarea>

        <div class="checkRow">
          <input id="isPrivate" type="checkbox" />
          <label for="isPrivate" style="margin:0;cursor:pointer;">ğŸ”’ ë¹„ë°€ê¸€ë¡œ ì˜¬ë¦¬ê¸°(ì‘ì„±ìë§Œ ì—´ëŒ)</label>
        </div>

        <div class="row">
          <button class="btn primary" id="btnAdd">ğŸ“ ì˜¬ë¦¬ê¸°</button>
          <button class="btn ghost" id="btnClear">ğŸ§¼ ì§€ìš°ê¸°</button>
        </div>

        <p class="mini">
          ìµëª… ë¡œê·¸ì¸ìœ¼ë¡œ â€œì‘ì„±ìâ€ê°€ êµ¬ë¶„ë¼ìš”. ë‹¤ë¥¸ ì‚¬ëŒì€ ë¹„ë°€ê¸€ ë‚´ìš©ì´ ì•ˆ ë³´ì´ê³ , ìˆ˜ì •/ì‚­ì œë„ ëª»í•´ìš”.
        </p>
      </div>

      <div class="card">
        <div class="toolbar">
          <div class="search">
            <input id="search" placeholder="ì œëª©/ë‚´ìš©/ë‹‰ë„¤ì„ ê²€ìƒ‰(ë¹„ë°€ê¸€ì€ ì‘ì„±ìë§Œ ë‚´ìš© ê²€ìƒ‰ë¨)" />
          </div>
          <div class="pill">ğŸ“ <span id="count">0</span> posts</div>
        </div>

        <div id="posts" class="posts"></div>
        <div id="empty" class="empty" style="display:none;">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ì–´ìš” ğŸ™‚</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIplfg8eF2ZsGx-LFziw1cb5WuMtd0Cnc",
      authDomain: "sara-bbb25.firebaseapp.com",
      projectId: "sara-bbb25",
      storageBucket: "sara-bbb25.firebasestorage.app",
      messagingSenderId: "386319278885",
      appId: "1:386319278885:web:8b65befd4c0d41910af0cc",
      measurementId: "G-8T80SNK8PP"
    };

    const $status = document.getElementById("status");
    const $nickname = document.getElementById("nickname");
    const $title = document.getElementById("title");
    const $content = document.getElementById("content");
    const $isPrivate = document.getElementById("isPrivate");
    const $posts = document.getElementById("posts");
    const $empty = document.getElementById("empty");
    const $search = document.getElementById("search");
    const $count = document.getElementById("count");
    const $toast = document.getElementById("toast");

    function toast(msg){
      $toast.textContent = msg;
      $toast.style.display = "block";
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> $toast.style.display="none", 1600);
    }
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function fmt(ts){
      if(!ts) return "ë°©ê¸ˆ";
      const d = ts.toDate();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ë‹‰ë„¤ì„ ì €ì¥
    const NKEY="cake_nick_v1";
    const savedNick = localStorage.getItem(NKEY);
    if(savedNick) $nickname.value = savedNick;
    $nickname.addEventListener("input", ()=>{
      const v = $nickname.value.trim();
      if(v) localStorage.setItem(NKEY, v);
    });

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let myUid = null;
    let allDocs = [];

    // ìµëª… ë¡œê·¸ì¸

    let unsubPublic = null;
    let unsubMine = null;
    onAuthStateChanged(auth, (user) => {
      if(user){
        myUid = user.uid;
        $status.textContent = `ë¡œê·¸ì¸ë¨ âœ… (ìµëª…)`;
    
        // ê¸°ì¡´ êµ¬ë… í•´ì œ
        if(unsubPublic) unsubPublic();
        if(unsubMine) unsubMine();
    
        // 1ï¸âƒ£ ê³µê°œê¸€ë§Œ
        const qPublic = query(
          collection(db, "posts"),
          where("isPrivate", "==", false),
          orderBy("createdAt", "desc")
        );
    
        // 2ï¸âƒ£ ë‚´ ê¸€ë§Œ
        const qMine = query(
          collection(db, "posts"),
          where("authorUid", "==", myUid),
          orderBy("createdAt", "desc")
        );
    
        let publicDocs = [];
        let myDocs = [];
    
        unsubPublic = onSnapshot(qPublic, (snap)=>{
          publicDocs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
          allDocs = mergeDocs(publicDocs, myDocs);
          render();
        });
    
        unsubMine = onSnapshot(qMine, (snap)=>{
          myDocs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
          allDocs = mergeDocs(publicDocs, myDocs);
          render();
        });
    
      } else {
        $status.textContent = "ë¡œê·¸ì¸ í•„ìš” âŒ";
      }
    });


    try{
      await signInAnonymously(auth);
    }catch(e){
      console.error(e);
      $status.textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨ âŒ (Authorized domains í™•ì¸)";
      toast("ë¡œê·¸ì¸ ì‹¤íŒ¨: Authentication > Authorized domainsì— park387.github.io ì¶”ê°€í–ˆëŠ”ì§€ í™•ì¸!");
    }

    // ê¸€ ì‘ì„±
    async function addPost(){
      if(!myUid){
        toast("ë¡œê·¸ì¸ ì—°ê²°ì´ ì•„ì§ ì•ˆ ëì–´ìš”. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ!");
        return;
      }
      const nickname = ($nickname.value.trim() || "guest").slice(0,20);
      const title = $title.value.trim();
      const content = $content.value.trim();
      const isPrivate = $isPrivate.checked;

      if(!title || !content){
        toast("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
        return;
      }

      try{
        await addDoc(collection(db, "posts"), {
          authorUid: myUid,
          nickname,
          title,
          content,
          isPrivate,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        $title.value = "";
        $content.value = "";
        $isPrivate.checked = false;
        toast("ì˜¬ë ¸ì–´ìš” ğŸ“");
      }catch(e){
        console.error(e);
        toast("ì—…ë¡œë“œ ì‹¤íŒ¨: Rules/Auth ì„¤ì • í™•ì¸!");
      }
    }

    document.getElementById("btnAdd").addEventListener("click", addPost);
    document.getElementById("btnClear").addEventListener("click", ()=>{
      $title.value=""; $content.value=""; $title.focus();
      toast("ì§€ì› ì–´ìš” ğŸ§¼");
    });

    $content.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && (e.ctrlKey || e.metaKey)){
        e.preventDefault(); addPost();
      }
    });

    $search.addEventListener("input", render);

    function matchesKw(p, kw){
      if(!kw) return true;
      const t = (p.title||"").toLowerCase();
      const n = (p.nickname||"").toLowerCase();
      const c = (p.content||"").toLowerCase();
      return t.includes(kw) || n.includes(kw) || c.includes(kw);
    }
    function mergeDocs(a, b){
      const map = new Map();
      for(const x of [...a, ...b]) map.set(x.id, x);
      return [...map.values()].sort((x,y)=>{
        const tx = x.data.createdAt?.toMillis?.() ?? 0;
        const ty = y.data.createdAt?.toMillis?.() ?? 0;
        return ty - tx;
      });
    }

    function render(){
      const kw = $search.value.trim().toLowerCase();

      const filtered = allDocs.filter(({data})=>{
        // ë¹„ë°€ê¸€ì€ ì‘ì„±ì ì•„ë‹ˆë©´ contentëŠ” í‘œì‹œë„ ê²€ìƒ‰ë„ ì˜ë¯¸ê°€ ì—†ìŒ(í•˜ì§€ë§Œ ê·œì¹™ìƒ read ìì²´ê°€ ì•ˆ ë  ìˆ˜ ìˆìŒ)
        // ê·œì¹™ì´ ì ìš©ë˜ë©´ ë¹„ë°€ê¸€ ë¬¸ì„œê°€ ì‘ì„±ìê°€ ì•„ë‹ˆë©´ ì•„ì˜ˆ snapshotì— ì•ˆ ì˜¬ ìˆ˜ë„ ìˆì–´ìš”.
        // ì˜¬ë¼ì˜¨ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œë§Œ ë Œë”.
        return matchesKw(data, kw);
      });

      $count.textContent = String(filtered.length);
      $posts.innerHTML = "";

      if(filtered.length === 0){
        $empty.style.display = "block";
        return;
      }
      $empty.style.display = "none";

      for(const item of filtered){
        const id = item.id;
        const p = item.data;
        const isOwner = (myUid && p.authorUid === myUid);
        const isPrivate = (p.isPrivate === true);

        // ë¹„ë°€ê¸€ì¸ë° ownerê°€ ì•„ë‹ˆë©´(ëŒ€ë¶€ë¶„ì€ rulesë¡œ ì•„ì˜ˆ ì•ˆ ë‚´ë ¤ì˜´)
        const canSeeContent = !isPrivate || isOwner;

        const div = document.createElement("div");
        div.className = "post";

        const title = escapeHtml(p.title);
        const nickname = escapeHtml(p.nickname || "guest");
        const time = escapeHtml(fmt(p.updatedAt || p.createdAt));

        const content = canSeeContent
          ? escapeHtml(p.content)
          : "ë¹„ë°€ê¸€ì…ë‹ˆë‹¤ ğŸ”’";

        div.innerHTML = `
          <h3>
            ${isPrivate ? '<span class="lock">ğŸ”’</span>' : '<span class="lock">ğŸ°</span>'}
            <span>${title}</span>
          </h3>

          <p>${content}</p>

          <div class="meta">
            <div class="left">
              <span class="tag">ğŸ° ${nickname}</span>
              <span class="tag">ğŸ•’ ${time}</span>
              ${isPrivate ? '<span class="tag">ë¹„ë°€ê¸€</span>' : '<span class="tag">ê³µê°œê¸€</span>'}
            </div>
            <div class="actions">
              ${isOwner ? `
                <button class="tiny" data-action="edit" data-id="${id}">ìˆ˜ì •</button>
                <button class="tiny danger" data-action="delete" data-id="${id}">ì‚­ì œ</button>
              ` : ``}
            </div>
          </div>

          ${isOwner ? `
            <div class="editBox" data-editbox="${id}" style="display:none;">
              <input data-ed-title="${id}" maxlength="60" value="${escapeHtml(p.title)}" />
              <textarea data-ed-content="${id}">${escapeHtml(p.content)}</textarea>
              <div class="checkRow" style="margin-top:2px">
                <input type="checkbox" data-ed-private="${id}" ${isPrivate ? "checked" : ""} />
                <label style="margin:0;cursor:pointer;">ğŸ”’ ë¹„ë°€ê¸€ ìœ ì§€</label>
              </div>
              <div class="row" style="margin-top:8px">
                <button class="btn primary" data-action="save" data-id="${id}">ì €ì¥</button>
                <button class="btn ghost" data-action="cancel" data-id="${id}">ì·¨ì†Œ</button>
              </div>
            </div>
          ` : ``}
        `;

        $posts.appendChild(div);
      }
    }

    // ì´ë²¤íŠ¸ ìœ„ì„: ìˆ˜ì •/ì‚­ì œ/ì €ì¥/ì·¨ì†Œ
    $posts.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;

      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if(!action || !id) return;

      const postRef = doc(db, "posts", id);

      if(action === "edit"){
        const box = document.querySelector(`[data-editbox="${id}"]`);
        if(box) box.style.display = (box.style.display === "none" ? "block" : "none");
        return;
      }

      if(action === "cancel"){
        const box = document.querySelector(`[data-editbox="${id}"]`);
        if(box) box.style.display = "none";
        return;
      }

      if(action === "save"){
        const t = document.querySelector(`[data-ed-title="${id}"]`)?.value?.trim();
        const c = document.querySelector(`[data-ed-content="${id}"]`)?.value?.trim();
        const priv = document.querySelector(`[data-ed-private="${id}"]`)?.checked === true;

        if(!t || !c){
          toast("ì œëª©/ë‚´ìš©ì´ ë¹„ì–´ ìˆì–´ìš”!");
          return;
        }

        try{
          await updateDoc(postRef, {
            title: t,
            content: c,
            isPrivate: priv,
            updatedAt: serverTimestamp()
          });
          toast("ìˆ˜ì • ì™„ë£Œ âœ¨");
        }catch(err){
          console.error(err);
          toast("ìˆ˜ì • ì‹¤íŒ¨: ì‘ì„±ìë§Œ ê°€ëŠ¥!");
        }
        return;
      }

      if(action === "delete"){
        if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
        try{
          await deleteDoc(postRef);
          toast("ì‚­ì œ ì™„ë£Œ ğŸ—‘ï¸");
        }catch(err){
          console.error(err);
          toast("ì‚­ì œ ì‹¤íŒ¨: ì‘ì„±ìë§Œ ê°€ëŠ¥!");
        }
        return;
      }
    });
  </script>
</body>
</html>
